---
title: "ProcessLEHD2019"
author: "Chris Day"
date: "2023-01-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(foreign)
library(sf)
library(jsonlite)
library(mapview)
library(imputeTS)
```

## Introduction
The LEHD Origin-Destination Employment Statistic (LODES) dataset is released yearly by the Census and provides geography based employment data. The https://wfrc.org/commuter-flow-map webapp displays an interactive comparison of this data. In this Rmarkdown, we wish to make the following updates to the webapp.

Updates: 
  - Update using 2019 data
  - Include a Small Districts geography
  - Include a comparison of StreetLight HBW trips

Outputs Needed:
  - Municipalities and Townships
  - Counties
  - BlockGroup CommutePatterns Number
  - BlockGroup CommutePatterns Percent MapUnit
  - BlockGroup CommutePatterns Percent SelectedArea
  - Tract CommutePatterns Number
  - Tract CommutePatterns Percent MapUnit
  - Tract CommutePatterns Percent SelectedArea
  - City CommutePatterns Number
  - City CommutePatterns Percent MapUnit
  - City CommutePatterns Percent SelectedArea
  - SD CommutePatterns Number
  - SD CommutePatterns Percent MapUnit
  - SD City CommutePatterns Percent SelectedArea
  - citytownshipdata.json
  - coutydata_number.json
  - coundydata_percent_sa.json
  - countydata_percent_mu.json
  
  
Key:
  - S000: Total Number of Jobs
  - [CODE3]_x: Work Who Live In [City/Township]
  - [CODE3]_y: Live Who Work In [City/Township]
  
## Prep LEHD Data
The first step is is to organize a geodatabase which includes all the data. Let's do that.

### Numerical Data
```{r}
#lehd 2018 data
lehd_raw <- read_csv("data/data2018/ut_od_main_JT00_2018.csv") %>%
  select(w_geocode, h_geocode, S000) # S000 is Number of Jobs

#township code daya
township_codes <- read_csv("data/data2019/citytownship.csv") %>%
  select(1,2)

#block/city data
blockcity_raw <- read.dbf("data/data2018/blockpoint_City.dbf") %>%
  select(-CODE3) %>%
  left_join(township_codes, by = c("SHORTDESC" = "SHORTDESC")) %>%
  select(GEOID10, CODE3, SHORTDESC) %>%
  mutate(GEOID10 = as.numeric(as.character(GEOID10)))

blockcity_wfrc <- blockcity_raw %>% filter(CODE3 %in% wfrc_towns)

wfrc_towns <- c("AFK","ALA","ALP","BDL","BGM","BNT","BRT","CDF","CEN","CHA","CHL","CLF","CLI","CMT","COA","CWH","DAN","DRA","EAG","ELK","EMT","FAR","FCS","FFD","FRR","FTH","GLA","GOS","GRL","HAR","HDT","HDT","HEB","HER","HGH","HNF","HOL","HOO","HVL","IND","INT","KAY","KMS","KMT","LAY","LEH","LIN","MAP","MID","MLC","MMT","MRG","MSL","MUR","MWY","NOG","NSL","OGD","OKL","ORM","PAY","PGR","PLN","PRK","PRY","PVO","PVW","ROY","RVD","RVT","SAN","SAQ","SAR","SFK","SJC","SLC","SLM","SOG","SPV","SSL","SUN","SWE","SYR","TAY","TOO","UIN","VIN","WAT","WBG","WDL","WEB","WHT","WHV","WIL","WJC","WPT","WVC","WXC")
```

### Geographic Data
```{r}
sf_small_districts <- st_read("data/data2019/Dist_Small/Dist_Small.shp")
sf_townships <- st_read("data/data2019/Municipalities_Township/Municipalities_Township.shp")
sf_blockgroups <- st_read("data/data2019/tl_2020_49_bg/tl_2020_49_bg.shp")
sf_counties <- st_read("data/data2019/Utah_County_Boundaries-shp/Counties.shp")

sf_census_counties <- st_read("data/data2019/Utah_Census_Counties_2020/CensusCounties2020.shp")
sf_census_tracts <- st_read("data/data2019/Utah_Census_Tracts_2020/CensusTracts2020.shp")

```


## LEHD Calculations
### City Township Analysis
Outputs to Create:
  - citytownshipdata.json
  - City CommutePatterns Number
  - City CommutePatterns Percent MapUnit
  - City CommutePatterns Percent SelectedArea

```{r}
homeside <- left_join(lehd_raw,blockcity_raw, by = c("h_geocode" = "GEOID10")) %>%
  mutate(h_geocode = as.character(h_geocode), w_geocode = as.character(w_geocode))
workside <- left_join(lehd_raw,blockcity_raw, by = c("w_geocode" = "GEOID10")) %>%
  mutate(h_geocode = as.character(h_geocode), w_geocode = as.character(w_geocode))
```

#### citytownshipdata.json
```{r}
#city township totals
h_citytownship <- homeside %>%
  group_by(CODE3,SHORTDESC) %>%
  summarize(people_x = sum(S000))
w_citytownship <- workside %>%
  group_by(CODE3,SHORTDESC) %>%
  summarize(people_y = sum(S000))
citytownship18 <- left_join(h_citytownship, w_citytownship) %>%
  rename('label' = SHORTDESC, 'value' = CODE3) %>%
  select(2,1,3,4) %>%
  filter(value != "XXX")
```

```{r}
#city township geographic view
ctgeo <- citytownship18 %>%
  left_join(sf_townships, by = c("label" = "SHORTDESC")) %>%
  st_as_sf()
```

```{r}
mapview(ctgeo, zcol = "people_x")
```

```{r}
mapview(ctgeo, zcol = "people_y")
```

```{r}
ctjson <- toJSON(citytownship18, pretty=TRUE) %>%
  write("citytownshipdata19.json")
```

#### City CommutePatterns
```{r}
homeside_wide <- homeside %>% filter(CODE3 %in% wfrc_towns) %>%
  arrange(CODE3) %>%
  select(-SHORTDESC, -h_geocode) %>%
  pivot_wider(names_from = CODE3, values_from = S000, values_fn = sum, names_glue = "{CODE3}_x") %>%
  na_replace(0)
homeside_wide_ttl <- homeside_wide %>%
  mutate(TTL_x = rowSums(.[2:93]))
write_csv(homeside_wide_ttl, "test.csv")

workside_wide <- workside %>% filter(CODE3 %in% wfrc_towns) %>%
  arrange(CODE3) %>%
  select(-SHORTDESC, -w_geocode) %>%
  pivot_wider(names_from = CODE3, values_from = S000, values_fn = sum, names_glue = "{CODE3}_y") %>%
  na_replace(0)
```

```{r}
city_x <- homeside %>% 
  filter(CODE3 %in% wfrc_towns) %>%
  select(-SHORTDESC) %>%
  rename("CODE3_h" = "CODE3") %>%
  mutate(w_geocode = as.double(w_geocode)) %>%
  left_join(blockcity_wfrc, by = c("w_geocode" = "GEOID10")) %>%
  rename("CODE3_w" = "CODE3") %>%
  select(-w_geocode,-h_geocode) %>% ungroup() %>%
  group_by(CODE3_h, CODE3_w, SHORTDESC) %>%
  summarize(SumS000 = sum(S000))

city_x_wide <- city_x %>%
  arrange(CODE3_h) %>%
  select(-SHORTDESC, -h_geocode) %>%
  pivot_wider(names_from = CODE3, values_from = S000, values_fn = sum, names_glue = "{CODE3}_x") %>%
  na_replace(0)

city_y <- workside %>%
  filter(CODE3 %in% wfrc_towns) %>%
  select(-SHORTDESC) %>%
  rename("CODE3_w" = "CODE3") %>%
  mutate(h_geocode = as.double(h_geocode)) %>%
  left_join(blockcity_wfrc, by = c("h_geocode" = "GEOID10")) %>%
  rename("CODE3_h" = "CODE3") %>%
  select(-w_geocode,-h_geocode) %>% ungroup() %>%
  group_by(CODE3_w, CODE3_h, SHORTDESC) %>%
  summarize(SumS000 = sum(S000))
  

left_join(lehd_raw,blockcity_raw, by = c("w_geocode" = "GEOID10"))
```






### County Data Number
```{r}
# calculate number selected area

```









